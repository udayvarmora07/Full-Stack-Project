name: backend-workflow
on: 
    workflow_run: 
        workflows: ["mysql-workflow"]
        types: [completed]
        branches: [main]
env:
    DOCKER_USERNAME: uday0710
jobs:
    backend-docker-build:
        runs-on: ubuntu-latest

        steps:
          - name: checkout
            uses: actions/checkout@v4
          - name: log in to docker hub
            uses: docker/login-action@v3
            with:
              username: ${{ env.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}
          - name: set up docker buildx
            uses: docker/setup-buildx-action@v3
          - name: build and push docker image
            uses: docker/build-push-action@v6
            with:
              file: ./backend/Dockerfile
              context: ./backend
              push: true
              tags: ${{env.DOCKER_USERNAME}}/backend-node:latest
    
    backend-kubernetes-deploy:
        runs-on: local-runner
        needs: backend-docker-build
        steps:
          - name: checkout
            uses: actions/checkout@v4
          - name: docker-container
            run: |
              docker run --name backend-node --network my-network -d -p 8085:80 uday0710/backend-node:latest